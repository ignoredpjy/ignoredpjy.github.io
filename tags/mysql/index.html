<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>mysql | PJY's Blog</title><meta name=keywords content><meta name=description content><meta name=author content="PJY"><link rel=canonical href=https://ignoredpjy.github.io/tags/mysql/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://ignoredpjy.github.io/img/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ignoredpjy.github.io/img/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ignoredpjy.github.io/img/favicon-32x32.png><link rel=apple-touch-icon href=https://ignoredpjy.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ignoredpjy.github.io/android-chrome-512x512.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://ignoredpjy.github.io/tags/mysql/index.xml><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="mysql"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://ignoredpjy.github.io/tags/mysql/"><meta name=twitter:card content="summary"><meta name=twitter:title content="mysql"><meta name=twitter:description content></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ignoredpjy.github.io accesskey=h title="PJY's Blog (Alt + H)"><img src=https://ignoredpjy.github.io/img/man-removebg.png alt aria-label=logo height=40>PJY's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ignoredpjy.github.io/posts/ title=📖文章><span>📖文章</span></a></li><li><a href=https://ignoredpjy.github.io/tags/ title=🏷️标签><span>🏷️标签</span></a></li><li><a href=https://ignoredpjy.github.io/search/ title=🔍搜索><span>🔍搜索</span></a></li><li><a href=https://ignoredpjy.github.io/archives/ title=📚归档><span>📚归档</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://ignoredpjy.github.io>🏠 主页</a>&nbsp;»&nbsp;<a href=https://ignoredpjy.github.io/tags/>🔖 标签</a></div><h1>mysql</h1></header><article class="post-entry tag-entry"><header class=entry-header><h2>mysql原理</h2></header><div class=entry-content><p>索引（B+树） 提到mysql索引，就不会不提：B+ 树 、B-树 和 红黑树
InnoDB 是最常用的存储引擎，B+树是InnoDB默认的索引机制。
B+树 VS B-树 VS 红黑树 磁盘知识 分页：
现代操作系统都使用虚拟内存来印射到物理内存，内存大小有限且价格昂贵，所以数据的持久化是在磁盘上。虚拟内存、物理内存、磁盘都使用页作为内存读取的最小单位。一般一页为4KB（8个扇区，每个扇区512B，8*512B=4KB）
局部性原理：
时间局部性：一个被引用过一次的内存位置很可能在不远的将来再次被多次引用。 空间局部性：当一个数据被用到时，其附近的数据也通常会马上被使用。程序运行期间所需要的数据通常比较集中。 顺序局部性（Order Locality）：在典型程序中，除转移类指令外，大部分指令是顺序进行的。顺序执行和非顺序执行的比例大致是5:1。此外，对大型数组访问也是顺序的。 磁盘IO速度 & 预读
速度：CPU » Cache »> 主内存 »» 磁盘， 磁盘读取的速度远小于内存，所以尽量减少 I/O 次数是提高效率的关键。
考虑到磁盘IO是非常高昂的操作，计算机操作系统做了一些优化，IO时，不光把当前磁盘地址的数据，而是把相邻的数据也都读取到内存缓冲区内，因为局部性原理。而且即使只需要读取一个字节，磁盘也会读取一页的数据。
查找树知识 二叉平衡树/二叉查找树
平衡树是为了防止二叉查找树退化为链表，而红黑树在维持平衡以确保 O(log2(n)) 的同时，不需要频繁着调整树的结构；
AVL树是最先发明的自平衡二叉查找树，AVL树中任何节点的两个子树的高度最大差别为1，所以它也被称为高度平衡树。通过旋转来实现自平衡 2-3 树，要求严格的平衡，通过允许3节点，减少自平衡次数 红黑树，不要求严格平衡，减少自平衡次数 b+/b-树
B树/B-树：所有节点存储数据和指针(索引)；
B+树
非叶子节点存储指针 (索引)，叶子节点存储数据； 每个叶子节点有一个指针指向下一个节点，构成一个有序链表 为什么不使用二叉树/红黑树，使用B+树 单拎出来一点，就已经足够否决的了
**为磁盘而生：**二叉树无法使用磁盘预读功能 , B树专门为磁盘读取而设计，B树的节点大小与磁盘页大小相匹配（InnoDB中页的大小 默认为 16 KB。） **更少的 IO 次数：**树的深度也会影响查询的效率，随着数据量增加，二叉树深度增长飞快，会造成查询时磁盘IO频繁读写，（B+树高度通常不超过3+1） **额外的平衡开销：**二叉树一次插入+平衡的过程，会涉及大量的磁盘I/O操作 更适于范围查询：二叉树存储在磁盘中，范围查询的效率极低，基本不支持范围查询 为什么不使用B-树，使用B+树 B+树非叶子节点仅存储索引不存储data，这样一个节点就可以存储更多的索引，可以使得B+树相对B树来说更矮（IO次数就是树的高度），所以I/O 次数更少
B+树所有叶子节点构成一个 有序链表，按主键排序来遍历全部记录，能更好支持范围查找和区间查找。而B树每个节点都可能查找到数据，相邻的元素可能在不同节点上，在内存中不相邻，所以范围查找时需要在叶子节点和子节点不停的往返移动，效率较低且不稳定
文件系统使用B-树，mongoDB使用B-树：
MongoDB 是一种 nosql，也存储在磁盘上，被设计用在 数据模型简单，性能要求高的场合。性能要求高，看看B/B+树的区别第一点：...</p></div><footer class=entry-footer><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>November 27, 2023
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>551字
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>3分钟
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>PJY
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta><a href=https://ignoredpjy.github.io/tags/mysql/ style=color:var(--secondary)!important>mysql</a></span></span></span></span></footer><a class=entry-link aria-label="post link to mysql原理" href=https://ignoredpjy.github.io/posts/study/mysql%E5%8E%9F%E7%90%86/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>事务传播机制</h2></header><div class=entry-content><p>Spring中七种事务传播行为 事务传播行为类型 说明 PROPAGATION_REQUIRED 如果当前没有事务，就新建一个事务，如果已经存在一个事务中，加入到这个事务中。这是最常见的选择。 PROPAGATION_SUPPORTS 支持当前事务，如果当前没有事务，就以非事务方式执行。 PROPAGATION_MANDATORY 使用当前的事务，如果当前没有事务，就抛出异常。 PROPAGATION_REQUIRES_NEW 新建事务，如果当前存在事务，把当前事务挂起。 PROPAGATION_NOT_SUPPORTED 以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。 PROPAGATION_NEVER 以非事务方式执行，如果当前存在事务，则抛出异常。 PROPAGATION_NESTED 如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则执行与PROPAGATION_REQUIRED类似的操作。 极端的传播 PROPAGATION_MANDATORY
使用外围事务，没有就报错
话说，这样的代码块为什么不直接写到外围方法里，干嘛新建子方法
没错就是为了单纯多写一个方法（程序员的事你少管）
PROPAGATION_NEVER
该方法无法被事务方法调用，一调就报错。
懒惰的传播 NOT_SUPPORTED
管你有没有事务，我就是没有
SUPPORTS
你的就是我的，你没有我也没有
如何触发回滚 该方法向外部抛出了一个异常 回滚是否向外传递 外围方法为 同一事务 ( REQUIRED )，回滚向外传递 外围方法没有try住异常，或者try住之后再次throw，回滚向外传递 （其实就是 外围方法自身触发回滚，本质不是传递） 外围方法是否为父事务(NESTED)，无屌关系 回滚是否向内传递 内部方法为 同一事务 ( REQUIRED )，回滚向内传递 内部方法为 父事务 (NESTED) ，回滚向内传递 REQUIRED （加入事务） 外围方法未开启事务
Propagation.REQUIRED修饰的内部方法会新开启自己的事务，且开启的事务相互独立，互不干扰。
外围方法开启事务
Propagation.REQUIRED修饰的内部方法会加入到外围方法的事务中，所有Propagation.REQUIRED修饰的内部方法和外围方法均属于同一事务，只要一个方法回滚，整个事务均回滚。
REQUIRES_NEW （新的事务） 外围方法未开启事务
同 REQUIRED
外围方法开启事务
Propagation.REQUIRES_NEW修饰的内部方法依然会单独开启独立事务，且与外部方法事务也独立，内部方法之间、内部方法和外部方法事务均相互独立，互不干扰。
NESTED （子事务） 外围方法未开启事务
同 REQUIRED
外围方法开启事务...</p></div><footer class=entry-footer><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>November 27, 2023
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>72字
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>1分钟
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>PJY
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta><a href=https://ignoredpjy.github.io/tags/spring/ style=color:var(--secondary)!important>spring</a>
&nbsp;<a href=https://ignoredpjy.github.io/tags/mysql/ style=color:var(--secondary)!important>mysql</a></span></span></span></span></footer><a class=entry-link aria-label="post link to 事务传播机制" href=https://ignoredpjy.github.io/posts/study/spring%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD/></a></article></main><footer class=footer><span>Build by pjy</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>